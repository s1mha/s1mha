const SHEET_NAME = "songs";
const SPREADSHEET_ID = "16LzMmx_X99Exy_AmNBFmfduPW1e-dKCm9yzb5LlkJk0";
const ADMIN_TOKEN = "s1mha0310";

function doGet(e){
  // action 없으면 HTML 페이지를 보여줌
  const action = e && e.parameter && e.parameter.action;
  if(!action){
    return HtmlService.createHtmlOutputFromFile("Index")
      .setTitle("심하노래책");
  }
  // action 있으면 API 응답
  return handleApi_(e);
}

function doPost(e){
  return handleApi_(e);
}

function handleApi_(e){
  try{
    const body = parseBody_(e);
    const action = body.action || (e && e.parameter && e.parameter.action) || "list";

    // ✅ 누구나 목록 조회 가능
    if(action === "list"){
      return json_({ ok:true, songs: readAll_() });
    }

    // ✅ auth/add/delete 는 토큰 필수
    const token = body.token || (e && e.parameter && e.parameter.token) || "";
    if(token !== ADMIN_TOKEN){
      return json_({ ok:false, error:"unauthorized" });
    }

    // ✅ 로그인 검증
    if(action === "auth"){
      return json_({ ok:true });
    }

    if(action === "add"){
      const artist = clean_(body.artist);
      const title  = clean_(body.title);
      if(!artist || !title) return json_({ ok:false, error:"missing_fields" });

      if(exists_(artist, title)) return json_({ ok:false, error:"duplicate" });

      const id = Utilities.getUuid().slice(0,8);
      sheet_().appendRow([id, artist, title]);
      return json_({ ok:true, id });
    }

    if(action === "delete"){
      const id = clean_(body.id);
      if(!id) return json_({ ok:false, error:"missing_id" });

      const sh = sheet_();
      const last = sh.getLastRow();
      if(last < 2) return json_({ ok:false, error:"not_found" });

      const ids = sh.getRange(2,1,last-1,1).getValues().flat().map(String);
      const idx = ids.findIndex(x => x === id);
      if(idx === -1) return json_({ ok:false, error:"not_found" });

      sh.deleteRow(idx + 2);
      return json_({ ok:true });
    }

    return json_({ ok:false, error:"unknown_action" });

  }catch(err){
    console.error(err);
    return json_({ ok:false, error:String(err) });
  }
}

function sheet_(){
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sh = ss.getSheetByName(SHEET_NAME);
  if(!sh) throw new Error("Sheet not found: " + SHEET_NAME);
  return sh;
}

function readAll_(){
  const sh = sheet_();
  const last = sh.getLastRow();
  if(last < 2) return [];
  const rows = sh.getRange(2,1,last-1,3).getValues();
  return rows
    .filter(r => r[0] && r[1] && r[2])
    .map(r => ({ id:String(r[0]), artist:String(r[1]), title:String(r[2]) }))
    .sort((a,b) => a.artist.localeCompare(b.artist,"ko") || a.title.localeCompare(b.title,"ko"));
}

function exists_(artist, title){
  const sh = sheet_();
  const last = sh.getLastRow();
  if(last < 2) return false;
  const values = sh.getRange(2,2,last-1,2).getValues(); // artist,title
  const key = normKey_(artist,title);
  return values.some(r => normKey_(r[0], r[1]) === key);
}

function normKey_(a,t){
  return clean_(a).toLowerCase() + "||" + clean_(t).toLowerCase();
}

function clean_(s){
  return (s ?? "").toString().trim().replace(/\s+/g," ");
}

function parseBody_(e){
  try{
    if(e && e.postData && e.postData.contents){
      return JSON.parse(e.postData.contents);
    }
  }catch(_){}
  return {};
}

function json_(obj){
  const out = ContentService.createTextOutput(JSON.stringify(obj));
  out.setMimeType(ContentService.MimeType.JSON);
  return out;
}
